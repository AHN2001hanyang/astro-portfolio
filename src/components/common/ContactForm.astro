---
/**
 * ContactForm.astro
 * 免后端联系表单（Formspree）
 * - 无 JS 也能提交；有 JS 时异步提交、显示成功/失败提示
 * - 含 honeypot 防垃圾（_gotcha）
 */
const FORM_ENDPOINT = 'https://formspree.io/f/xkgvwwzl';
---

<form
  id="contact-form"
  action={FORM_ENDPOINT}
  method="POST"
  class="card-glass p-6 sm:p-8 mt-6 text-left"
>
  <div class="grid gap-4 sm:grid-cols-2">
    <div>
      <label for="cf-name" class="block text-sm font-medium">Name / 이름 / 姓名</label>
      <input
        id="cf-name" name="name" type="text" required
        autocomplete="name"
        class="mt-1 w-full rounded-xl border bg-white/70 px-3 py-2 outline-none transition placeholder:text-slate-400 dark:bg-slate-900/70 focus:ring-2 focus:ring-blue-500"
        placeholder="Your name"
      />
    </div>

    <div>
      <label for="cf-email" class="block text-sm font-medium">Email</label>
      <input
        id="cf-email" name="email" type="email" required
        autocomplete="email"
        class="mt-1 w-full rounded-xl border bg-white/70 px-3 py-2 outline-none transition placeholder:text-slate-400 dark:bg-slate-900/70 focus:ring-2 focus:ring-blue-500"
        placeholder="you@example.com"
      />
    </div>

    <div class="sm:col-span-2">
      <label for="cf-message" class="block text-sm font-medium">Message / 문의 / 留言</label>
      <textarea
        id="cf-message" name="message" rows={5} required
        class="mt-1 w-full rounded-xl border bg-white/70 px-3 py-2 outline-none transition placeholder:text-slate-400 dark:bg-slate-900/70 focus:ring-2 focus:ring-blue-500"
        placeholder="Tell me how I can help…"
      ></textarea>
    </div>
  </div>

  <!-- honeypot（防机器人）：人类看不见 -->
  <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true" />

  <div class="mt-5 flex items-center gap-3">
    <button
      id="cf-submit"
      type="submit"
      class="anchor-btn bg-blue-600 text-white border-blue-600 hover:opacity-90"
    >
      Send
    </button>
    <span id="cf-status" class="text-sm opacity-80" aria-live="polite"></span>
  </div>

  <p class="mt-3 text-xs text-muted-foreground">
    This form uses <a class="underline" href="https://formspree.io" target="_blank" rel="noopener">Formspree</a> to deliver messages.
  </p>
</form>

<script>
  // 让有 JS 的浏览器走异步提交流程（无刷新）
  const form = document.getElementById('contact-form');
  const submitBtn = document.getElementById('cf-submit');
  const status = document.getElementById('cf-status');

  form?.addEventListener('submit', async (e) => {
    // 若浏览器不支持 fetch/FormData，就回退到原生提交
    if (!window.fetch || !window.FormData) return;
    e.preventDefault();

    status.textContent = '';
    submitBtn.setAttribute('disabled', 'true');

    try {
      const formData = new FormData(form);
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' },
      });

      if (res.ok) {
        form.reset();
        status.textContent = '✅ Message sent. I will get back to you soon.';
      } else {
        const data = await res.json().catch(() => ({}));
        status.textContent = data?.errors?.[0]?.message || '❌ Failed to send. Please try again later.';
      }
    } catch (err) {
      status.textContent = '❌ Network error. Please try again.';
    } finally {
      submitBtn.removeAttribute('disabled');
    }
  });
</script>
